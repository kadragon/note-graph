# Environment Configuration

runtime:
  platform: cloudflare-workers
  node_version: compatible # Workers use V8, not Node
  typescript_version: "^5.0.0"

dependencies:
  core:
    - hono # Web framework for Workers
    - zod # Runtime validation

  cloudflare:
    - "@cloudflare/workers-types"
    - wrangler # CLI for development and deployment

  ai:
    - openai # For AI Gateway calls

  pdf:
    - unpdf # Edge-compatible PDF text extraction

  testing:
    - vitest # Fast unit test runner
    - "@cloudflare/vitest-pool-workers" # Workers environment testing

  utilities:
    - nanoid # ID generation
    - date-fns # Date manipulation

cloudflare_bindings:
  d1_databases:
    - DB # Main database binding

  vectorize:
    - VECTORIZE # Vector index binding

  queues:
    - PDF_QUEUE # PDF processing queue

  r2_buckets:
    - PDF_TEMP_STORAGE # Temporary PDF storage

  ai_gateway:
    - AI_GATEWAY # OpenAI proxy with rate limiting

ai_config:
  gateway_id: worknote-ai-gateway
  models:
    chat: gpt-4.5-turbo
    embedding: text-embedding-3-small
  rate_limits:
    daily: 300
    monthly: 6000

database:
  name: worknote-db
  migrations_path: "./migrations"

vectorize:
  index_name: worknote-vectors
  dimensions: 1536 # text-embedding-3-small
  metric: cosine

build:
  entry_point: src/index.ts
  output: dist/index.js
  bundle: true
  minify: true

development:
  local_protocol: http
  local_port: 8787

  # Local development uses Miniflare
  # D1 local database: .wrangler/state/v3/d1
  # Vectorize: in-memory simulation (limited functionality)

testing:
  framework: vitest
  pool: "@cloudflare/vitest-pool-workers"
  coverage: true
  coverage_threshold:
    statements: 80
    branches: 75
    functions: 80
    lines: 80

project_structure:
  source: src/
  tests: src/**/*.test.ts
  types: src/types/
  migrations: migrations/
  specs: .spec/
  tasks: .tasks/
  governance: .governance/

conventions:
  id_format:
    person: 6-digit string (e.g., "310170")
    work: WORK-{ulid}
    todo: TODO-{ulid}
    spec: SPEC-{feature-name}-{number}
    task: TASK-{number}

  date_format:
    storage: ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ)
    display: locale-specific (Korean)

  text_encoding: UTF-8

  api_versioning: none (single-user, can break freely)

constraints:
  cloudflare_free_tier:
    d1:
      max_database_size: 500 MB
      max_rows_read_per_day: 5M
      max_rows_written_per_day: 100K

    workers:
      requests_per_day: 100K
      cpu_time_per_request: 10ms (non-bundled), 50ms (bundled)

    vectorize:
      vectors_per_index: 200K (free tier - verify)
      metadata_size_per_field: 64 bytes

    queues:
      messages_per_day: 1M

    r2:
      storage: 10 GB
      class_a_operations_per_month: 1M
      class_b_operations_per_month: 10M

notes:
  - Single-user system, no multi-tenancy concerns
  - All user-facing text in Korean
  - All technical artifacts in English
  - Cloudflare Access handles authentication, no custom auth logic needed
  - PDF files are temporary (TTL 1 day), not for long-term storage
  - FTS uses trigram tokenizer for Korean support
  - Vectorize metadata limited to filter keys only, join with D1 for full data
