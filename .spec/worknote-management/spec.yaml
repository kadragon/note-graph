spec_id: SPEC-worknote-1
title: "Work Note Management with Versioning"
description: >
  Create, read, update, delete work notes with automatic versioning.
  Maintain relationships between work notes and persons.
  Keep latest 5 versions only.

given_when_then:
  - given: "User has text content for new work note"
    when: "User creates work note with title, content, category, and persons"
    then: >
      Work note is saved with generated work_id,
      person associations created,
      first version snapshot saved

  - given: "Existing work note"
    when: "User updates work note content"
    then: >
      Work note updated,
      new version created,
      oldest version deleted if total > 5 versions

  - given: "Work note with 5 versions"
    when: "User updates work note again"
    then: "6th version created and 1st version (oldest) deleted automatically"

  - given: "Work note associated with persons"
    when: "User views work note detail"
    then: "All associated persons shown with their roles (OWNER/RELATED)"

  - given: "Work note has related work notes"
    when: "User views work note detail"
    then: "Related work note links are displayed"

acceptance_tests:
  - id: TEST-worknote-1
    desc: "Create work note with persons"
    steps:
      - "POST /work-notes with title, content, category"
      - "Include persons array with personId and role"
      - "Verify work note created with generated ID"
      - "Verify work_note_person entries created"
      - "Verify first version saved"

  - id: TEST-worknote-2
    desc: "Update work note creates new version"
    steps:
      - "Create work note"
      - "PUT /work-notes/{workId} with updated content"
      - "Verify work note updated"
      - "Query versions, verify 2 versions exist"

  - id: TEST-worknote-3
    desc: "Version limit enforced (max 5)"
    steps:
      - "Create work note"
      - "Update 5 times (total 6 versions)"
      - "Query versions for work note"
      - "Verify only 5 versions exist"
      - "Verify oldest version removed"

  - id: TEST-worknote-4
    desc: "Filter work notes by category"
    steps:
      - "Create work notes with different categories"
      - "GET /work-notes?category=수업성적"
      - "Verify only matching work notes returned"

  - id: TEST-worknote-5
    desc: "Delete work note"
    steps:
      - "Create work note"
      - "DELETE /work-notes/{workId}"
      - "Verify work note deleted"
      - "Verify associated persons, versions, todos also deleted (cascade)"

dependencies:
  governance:
    - "work_id format: WORK-{ulid}"
    - "Version limit: 5"

linked_tasks: []

technical_notes:
  - "work_id generated using ULID for time-ordered IDs"
  - "Versions stored in work_note_versions table"
  - "Automatic version pruning on each update"
  - "Cascade delete: work note → persons, relations, versions, todos"
  - "Category is free-text field for flexibility"
  - "content_raw stored as TEXT, rendering handled client-side"

database_schema:
  work_notes:
    - work_id TEXT PRIMARY KEY
    - title TEXT
    - content_raw TEXT
    - category TEXT
    - created_at TEXT
    - updated_at TEXT

  work_note_person:
    - id INTEGER PRIMARY KEY AUTOINCREMENT
    - work_id TEXT NOT NULL REFERENCES work_notes(work_id)
    - person_id TEXT NOT NULL REFERENCES persons(person_id)
    - role TEXT # OWNER or RELATED

  work_note_relation:
    - id INTEGER PRIMARY KEY AUTOINCREMENT
    - work_id TEXT NOT NULL
    - related_work_id TEXT NOT NULL

  work_note_versions:
    - id INTEGER PRIMARY KEY AUTOINCREMENT
    - work_id TEXT NOT NULL REFERENCES work_notes(work_id)
    - version_no INTEGER
    - title TEXT
    - content_raw TEXT
    - category TEXT
    - created_at TEXT

api_endpoints:
  - method: GET
    path: /work-notes
    query_params:
      - q: keyword search
      - category: filter by category
      - personId: filter by associated person
      - deptName: filter by department
      - from: date range start
      - to: date range end

  - method: POST
    path: /work-notes

  - method: GET
    path: /work-notes/{workId}

  - method: PUT
    path: /work-notes/{workId}

  - method: DELETE
    path: /work-notes/{workId}
