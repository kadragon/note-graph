spec_id: SPEC-todo-1
title: "Todo Management with Recurrence and Wait Logic"
description: >
  Manage todos associated with work notes.
  Support recurrence (repeat rules) with two generation strategies.
  Implement wait_until logic to defer visibility until specified date.

given_when_then:
  - given: "Work note exists"
    when: "User creates todo with due date and repeat rule"
    then: "Todo created and associated with work note"

  - given: "Todo with repeat_rule=WEEKLY and recurrence_type=DUE_DATE"
    when: "User marks todo as complete"
    then: "New todo instance created with due_date = old_due_date + 1 week"

  - given: "Todo with repeat_rule=MONTHLY and recurrence_type=COMPLETION_DATE"
    when: "User marks todo as complete on 2025-11-20"
    then: "New todo instance created with due_date = 2025-12-20"

  - given: "Todo has wait_until=2025-11-25"
    when: "User views 'Today' dashboard on 2025-11-18"
    then: "Todo is hidden from Today view (now < wait_until)"

  - given: "Todo has wait_until=2025-11-15"
    when: "User views 'Today' dashboard on 2025-11-18"
    then: "Todo is visible in Today view (now >= wait_until)"

  - given: "Todo has due_date=2025-11-10 and status != completed"
    when: "User views dashboard on 2025-11-18"
    then: "Todo appears in Backlog section (overdue)"

  - given: "Multiple todos with different statuses"
    when: "User filters todos by status='진행중'"
    then: "Only todos with matching status returned"

acceptance_tests:
  - id: TEST-todo-1
    desc: "Create todo for work note"
    steps:
      - "Create work note"
      - "POST /work-notes/{workId}/todos with title, dueDate, repeatRule"
      - "Verify todo created with generated ID"
      - "Verify todo linked to work note"

  - id: TEST-todo-2
    desc: "Recurrence with DUE_DATE strategy"
    steps:
      - "Create todo with due=2025-11-18, repeat=WEEKLY, recurrence_type=DUE_DATE"
      - "Mark todo complete on 2025-11-20"
      - "Verify new todo created with due=2025-11-25"
      - "Verify old todo status=완료"

  - id: TEST-todo-3
    desc: "Recurrence with COMPLETION_DATE strategy"
    steps:
      - "Create todo with due=2025-11-18, repeat=MONTHLY, recurrence_type=COMPLETION_DATE"
      - "Mark todo complete on 2025-11-25"
      - "Verify new todo created with due=2025-12-25"

  - id: TEST-todo-4
    desc: "Wait_until hides todo from Today view"
    steps:
      - "Create todo with due=2025-11-20, wait_until=2025-11-22"
      - "GET /todos?view=today on 2025-11-20"
      - "Verify todo NOT in results (now < wait_until)"
      - "GET /todos?view=today on 2025-11-23"
      - "Verify todo IN results (now >= wait_until)"

  - id: TEST-todo-5
    desc: "Overdue todos appear in backlog"
    steps:
      - "Create todo with due=2025-11-10, status=진행중"
      - "GET /todos?view=backlog on 2025-11-18"
      - "Verify todo appears (due < now and status != 완료)"

  - id: TEST-todo-6
    desc: "Update todo status"
    steps:
      - "Create todo"
      - "PATCH /todos/{todoId} with status=완료"
      - "Verify todo status updated"
      - "If repeat_rule != NONE, verify new instance created"

dependencies:
  governance:
    - "todo_id format: TODO-{ulid}"
    - "Repeat interval calculation"
    - "Korean status values: 진행중, 완료, 보류, 중단"

linked_tasks: []

technical_notes:
  - "wait_until logic: filter at query time, not stored flag"
  - "Recurrence generation happens on status change to '완료'"
  - "New todo inherits: title, description, repeat_rule, recurrence_type, work_id"
  - "New todo gets: new todo_id, new created_at, status=진행중, calculated due_date"
  - "Backlog definition: due_date < now AND status != '완료'"
  - "Dashboard views (today/this_week/this_month) filter by: due_date range AND wait_until <= now"

database_schema:
  todos:
    - todo_id TEXT PRIMARY KEY
    - work_id TEXT NOT NULL REFERENCES work_notes(work_id)
    - title TEXT
    - description TEXT
    - created_at TEXT
    - due_date TEXT
    - wait_until TEXT
    - status TEXT # 진행중, 완료, 보류, 중단
    - repeat_rule TEXT # NONE, DAILY, WEEKLY, MONTHLY
    - recurrence_type TEXT # DUE_DATE, COMPLETION_DATE

api_endpoints:
  - method: GET
    path: /work-notes/{workId}/todos

  - method: POST
    path: /work-notes/{workId}/todos

  - method: GET
    path: /todos
    query_params:
      - view: today | this_week | this_month | backlog | all

  - method: PATCH
    path: /todos/{todoId}
    body:
      - status: optional
      - title: optional
      - description: optional
      - due_date: optional
      - wait_until: optional
