# Cloudflare Workers Configuration
# See: https://developers.cloudflare.com/workers/wrangler/configuration/
# Trace: SPEC-ai-draft-1, SPEC-rag-1, TASK-026

name = "note-graph"
main = "apps/worker/src/index.ts"
compatibility_date = "2025-01-01"

# Disable workers.dev subdomain (using custom domain instead)
workers_dev = false

# Disable preview URLs
preview_urls = false

# Account ID - Replace with your Cloudflare account ID
# account_id = "your-account-id-here"

# ============================================================================
# Custom Domain Routes
# ============================================================================
routes = [
  { pattern = "note.kadragon.work", custom_domain = true }
]

# ============================================================================
# Smart Placement
# ============================================================================
[placement]
mode = "smart"

# ============================================================================
# D1 Database
# ============================================================================
[[d1_databases]]
binding = "DB"
database_name = "worknote-db"
database_id = "04d814ad-5e61-4502-9e1d-85cfcdd1bea9"
migrations_dir = "migrations"

# ============================================================================
# Vectorize
# ============================================================================
[[vectorize]]
binding = "VECTORIZE"
index_name = "worknote-vectors"
remote = true
# Configure via CLI: wrangler vectorize create worknote-vectors --dimensions=1536 --metric=cosine

# ============================================================================
# R2 Bucket (for project files)
# ============================================================================
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "worknote-files"
# Configure via CLI: wrangler r2 bucket create worknote-files

# ============================================================================
# AI Gateway (for OpenAI API)
# ============================================================================
[ai]
binding = "AI_GATEWAY"
remote = true

# ============================================================================
# Environment Variables (Development)
# ============================================================================
[vars]
ENVIRONMENT = "development"
AI_GATEWAY_ID = "worknote-maker"
OPENAI_MODEL_CHAT = "gpt-5.1"
OPENAI_MODEL_EMBEDDING = "text-embedding-3-small"
OPENAI_MODEL_LIGHTWEIGHT = "gpt-5-mini"
# Google OAuth (필수)
GOOGLE_REDIRECT_URI = "https://note.kadragon.work/api/auth/google/callback"

# ============================================================================
# Production Environment Variables (use wrangler secret for sensitive data)
# ============================================================================
# CLOUDFLARE_ACCOUNT_ID - Set via: wrangler secret put CLOUDFLARE_ACCOUNT_ID
# OPENAI_API_KEY - Set via: wrangler secret put OPENAI_API_KEY
# CF_AIG_AUTHORIZATION - (Optional) Set via: wrangler secret put CF_AIG_AUTHORIZATION
# GOOGLE_CLIENT_ID - (Required) Set via: wrangler secret put GOOGLE_CLIENT_ID
# GOOGLE_CLIENT_SECRET - (Required) Set via: wrangler secret put GOOGLE_CLIENT_SECRET
# GDRIVE_ROOT_FOLDER_ID - (Required) Set via: wrangler secret put GDRIVE_ROOT_FOLDER_ID

# ============================================================================
# Development Settings
# ============================================================================
[dev]
port = 8787
local_protocol = "http"

# ============================================================================
# Build Configuration
# ============================================================================
# Wrangler uses ES modules format by default (no build config needed for TypeScript)
# Note: TypeScript path mapping (@shared/*) is configured in tsconfig.json

# ============================================================================
# Static Assets
# ============================================================================
[assets]
directory = "dist/web"
binding = "ASSETS"

# ============================================================================
# Observability
# ============================================================================
[observability]
enabled = true

[observability.logs]
enabled = true
invocation_logs = true
head_sampling_rate = 0.1

# ============================================================================
# IMPORTANT NOTES
# ============================================================================
# Development Setup:
# 1. Copy .dev.vars.example to .dev.vars
# 2. Update .dev.vars with your CLOUDFLARE_ACCOUNT_ID and Google OAuth variables
# 3. Create D1 database: wrangler d1 create worknote-db
# 4. Create Vectorize index: wrangler vectorize create worknote-vectors --dimensions=1536 --metric=cosine
# 5. Create AI Gateway in Cloudflare Dashboard: https://dash.cloudflare.com/?to=/:account/ai/ai-gateway
# 6. Update AI_GATEWAY_ID in [vars] section with your gateway name
# 7. Update database_id in [[d1_databases]] section after creation
#
# Production Setup:
# 1. Set secrets:
#    - wrangler secret put CLOUDFLARE_ACCOUNT_ID
#    - wrangler secret put OPENAI_API_KEY
#    - wrangler secret put CF_AIG_AUTHORIZATION (optional, if gateway requires auth)
