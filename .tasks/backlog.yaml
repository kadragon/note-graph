# Task Backlog
# Tasks ordered by priority (highest first)

tasks:
  # ============================================================================
  # PHASE 1: Infrastructure & Core Setup
  # ============================================================================

  - task_id: TASK-001
    spec_id: SPEC-auth-1
    title: "Initialize Cloudflare Workers project with Wrangler"
    description: |
      Set up base project structure with Wrangler CLI.
      - Initialize wrangler.toml configuration
      - Configure TypeScript with strict mode
      - Set up package.json with dependencies (hono, zod, etc.)
      - Create src/ directory structure
      - Configure build and dev scripts
    priority: 1
    status: pending
    estimated_effort: 2h
    acceptance_criteria:
      - "wrangler dev runs successfully"
      - "TypeScript compilation works"
      - "Basic Hono app responds to health check"

  - task_id: TASK-002
    spec_id: SPEC-worknote-1
    title: "Create D1 database schema and migrations"
    description: |
      Design and implement complete D1 schema.
      - Create migration files for all tables (persons, departments, work_notes, todos, etc.)
      - Set up FTS5 virtual table with trigram tokenizer
      - Create triggers for FTS synchronization
      - Add indexes for common query patterns
      - Document schema in migrations/
    priority: 1
    status: completed
    estimated_effort: 4h
    test_refs:
      - TEST-worknote-1
      - TEST-person-1
      - TEST-dept-1
    acceptance_criteria:
      - "All tables created via migrations"
      - "FTS triggers functional"
      - "Schema matches PRD specifications"

  - task_id: TASK-003
    spec_id: SPEC-auth-1
    title: "Implement authentication middleware"
    description: |
      Create middleware to extract and validate Cloudflare Access headers.
      - Extract Cf-Access-Authenticated-User-Email
      - Create auth context for requests
      - Implement /me endpoint
      - Add error handling for missing auth
    priority: 1
    status: pending
    estimated_effort: 2h
    test_refs:
      - TEST-auth-1
      - TEST-auth-2
    acceptance_criteria:
      - "Auth middleware extracts user email"
      - "/me endpoint returns user info"
      - "Unauthorized requests return 401"

  - task_id: TASK-004
    spec_id: SPEC-worknote-1
    title: "Set up Hono API structure and routing"
    description: |
      Create modular API routing structure with Hono.
      - Define route groups (/persons, /departments, /work-notes, /todos, etc.)
      - Implement request validation with Zod
      - Create error handling middleware
      - Set up response formatting utilities
    priority: 1
    status: pending
    estimated_effort: 3h
    acceptance_criteria:
      - "All API route groups defined"
      - "Request validation works"
      - "Consistent error responses"

  # ============================================================================
  # PHASE 2: Entity Management (Basic CRUD)
  # ============================================================================

  - task_id: TASK-005
    spec_id: SPEC-person-1
    title: "Implement Person repository and CRUD endpoints"
    description: |
      Create person management with department history tracking.
      - PersonRepository with D1 queries
      - POST /persons (with auto history entry)
      - GET /persons (with search)
      - GET /persons/{personId}
      - PUT /persons/{personId} (update history on dept change)
      - GET /persons/{personId}/history
    priority: 2
    status: pending
    estimated_effort: 4h
    test_refs:
      - TEST-person-1
      - TEST-person-2
      - TEST-person-4
    acceptance_criteria:
      - "All person endpoints functional"
      - "Department history auto-updated"
      - "Search works"

  - task_id: TASK-006
    spec_id: SPEC-dept-1
    title: "Implement Department repository and CRUD endpoints"
    description: |
      Create department management.
      - DepartmentRepository with D1 queries
      - POST /departments
      - GET /departments
      - GET /departments/{deptName}
      - PUT /departments/{deptName}
      - GET /departments/{deptName}/work-notes (join query)
    priority: 2
    status: pending
    estimated_effort: 3h
    test_refs:
      - TEST-dept-1
      - TEST-dept-2
      - TEST-dept-3
    acceptance_criteria:
      - "All department endpoints functional"
      - "Department member filtering works"
      - "Work note associations correct"

  - task_id: TASK-007
    spec_id: SPEC-worknote-1
    title: "Implement WorkNote repository with versioning"
    description: |
      Create work note management with automatic version control.
      - WorkNoteRepository with D1 batch transactions
      - POST /work-notes (create + first version + person associations)
      - GET /work-notes (with filters: category, person, dept, date range)
      - GET /work-notes/{workId}
      - PUT /work-notes/{workId} (update + new version + prune old versions)
      - DELETE /work-notes/{workId} (cascade delete)
      - Version pruning logic (keep max 5)
    priority: 2
    status: pending
    estimated_effort: 6h
    test_refs:
      - TEST-worknote-1
      - TEST-worknote-2
      - TEST-worknote-3
      - TEST-worknote-4
      - TEST-worknote-5
    acceptance_criteria:
      - "CRUD operations work"
      - "Versions auto-created and pruned"
      - "Person associations maintained"
      - "Cascade delete works"

  - task_id: TASK-008
    spec_id: SPEC-todo-1
    title: "Implement Todo repository with recurrence logic"
    description: |
      Create todo management with repeat rules and wait_until logic.
      - TodoRepository with recurrence strategies
      - POST /work-notes/{workId}/todos
      - GET /todos with view filters (today, this_week, this_month, backlog, all)
      - PATCH /todos/{todoId} (status update triggers recurrence)
      - Implement DueDateRecurrence and CompletionDateRecurrence strategies
      - Wait_until filtering in queries
      - Backlog calculation (due < now AND status != completed)
    priority: 2
    status: pending
    estimated_effort: 6h
    test_refs:
      - TEST-todo-1
      - TEST-todo-2
      - TEST-todo-3
      - TEST-todo-4
      - TEST-todo-5
      - TEST-todo-6
    acceptance_criteria:
      - "Todo CRUD works"
      - "Recurrence types generate correctly"
      - "Wait_until filters properly"
      - "Backlog view shows overdue items"

  # ============================================================================
  # PHASE 3: Search & AI Features
  # ============================================================================

  - task_id: TASK-009
    spec_id: SPEC-search-1
    title: "Implement FTS lexical search"
    description: |
      Enable full-text search using D1 FTS5.
      - Verify FTS triggers working
      - Create FTS query service
      - Implement Korean partial matching with trigram
      - Return ranked results
    priority: 3
    status: pending
    estimated_effort: 3h
    test_refs:
      - TEST-search-1
    acceptance_criteria:
      - "FTS queries return relevant results"
      - "Korean partial matching works"
      - "Results ranked by relevance"

  - task_id: TASK-010
    spec_id: SPEC-search-1
    title: "Set up Vectorize index and embedding service"
    description: |
      Configure Cloudflare Vectorize for semantic search.
      - Create Vectorize index (1536 dimensions, cosine metric)
      - Implement embedding service using text-embedding-3-small via AI Gateway
      - Create metadata encoding utilities (compact person_ids, etc.)
      - Implement upsert on work note create/update
      - Implement delete on work note delete
    priority: 3
    status: pending
    estimated_effort: 5h
    test_refs:
      - TEST-search-2
    acceptance_criteria:
      - "Vectorize index created"
      - "Embeddings generated correctly"
      - "Metadata within 64-byte limits"
      - "Upsert and delete work"

  - task_id: TASK-011
    spec_id: SPEC-search-1
    title: "Implement hybrid search with RRF ranking"
    description: |
      Combine FTS and Vectorize results using Reciprocal Rank Fusion.
      - POST /search/work-notes endpoint
      - Execute parallel FTS and Vectorize queries
      - Implement RRF algorithm (k=60)
      - Merge and sort results
      - Apply filters (person, dept, category, date)
      - Return with source attribution (LEXICAL/SEMANTIC/HYBRID)
    priority: 3
    status: pending
    estimated_effort: 5h
    test_refs:
      - TEST-search-3
      - TEST-search-4
      - TEST-search-5
    acceptance_criteria:
      - "Hybrid search endpoint works"
      - "RRF ranking correct"
      - "Filters apply to both search types"
      - "Source attribution accurate"

  - task_id: TASK-012
    spec_id: SPEC-rag-1
    title: "Implement chunking and RAG pipeline"
    description: |
      Build RAG system for contextual Q&A.
      - Implement chunking algorithm (512 tokens, 20% overlap)
      - Create chunk embedding and indexing on work note save
      - Implement POST /rag/query endpoint
      - Support scope filtering (GLOBAL, PERSON, DEPT, WORK)
      - Implement prompt construction with retrieved chunks
      - Call GPT-4.5 via AI Gateway
      - Return answer with source references
    priority: 3
    status: pending
    estimated_effort: 8h
    test_refs:
      - TEST-rag-1
      - TEST-rag-2
      - TEST-rag-3
      - TEST-rag-4
      - TEST-rag-5
    acceptance_criteria:
      - "Chunking works correctly"
      - "RAG queries return relevant answers"
      - "Scope filters work"
      - "Source chunks included in response"

  - task_id: TASK-013
    spec_id: SPEC-ai-draft-1
    title: "Implement AI draft generation from text"
    description: |
      Enable AI-powered work note draft creation.
      - POST /ai/work-notes/draft-from-text endpoint
      - Implement prompt template for draft generation
      - Parse AI response into WorkNoteDraft schema
      - Generate todo suggestions
      - POST /ai/work-notes/{workId}/todo-suggestions endpoint
      - Handle AI Gateway rate limits (return 429)
    priority: 3
    status: pending
    estimated_effort: 4h
    test_refs:
      - TEST-ai-draft-1
      - TEST-ai-draft-2
      - TEST-ai-draft-3
      - TEST-ai-draft-4
      - TEST-ai-draft-5
    acceptance_criteria:
      - "Draft generation works"
      - "Todo suggestions generated"
      - "Rate limit handling works"
      - "Korean output quality good"

  # ============================================================================
  # PHASE 4: Advanced Features (PDF Processing)
  # ============================================================================

  - task_id: TASK-014
    spec_id: SPEC-pdf-1
    title: "Implement PDF upload and job creation"
    description: |
      Set up PDF upload endpoint and R2 storage.
      - POST /pdf-jobs endpoint (multipart/form-data)
      - Upload PDF to R2 with TTL
      - Create pdf_jobs table entry
      - Send message to PDF_QUEUE
      - Return jobId with status=PENDING
      - GET /pdf-jobs/{jobId} polling endpoint
    priority: 4
    status: pending
    estimated_effort: 4h
    test_refs:
      - TEST-pdf-1
      - TEST-pdf-4
    acceptance_criteria:
      - "PDF upload works"
      - "R2 storage configured"
      - "Job tracking functional"
      - "Queue message sent"

  - task_id: TASK-015
    spec_id: SPEC-pdf-1
    title: "Implement PDF queue consumer with unpdf"
    description: |
      Create queue consumer for async PDF processing.
      - Set up Queue consumer Worker
      - Fetch PDF from R2
      - Extract text using unpdf
      - Call AI draft generation with extracted text
      - Update job status to READY with draft
      - Delete PDF from R2
      - Error handling and job status updates
      - Retry logic (max 3 attempts)
    priority: 4
    status: pending
    estimated_effort: 6h
    test_refs:
      - TEST-pdf-2
      - TEST-pdf-3
      - TEST-pdf-5
    acceptance_criteria:
      - "Consumer processes PDFs"
      - "Text extraction works"
      - "Draft generation successful"
      - "Error handling robust"
      - "Cleanup works"

  # ============================================================================
  # PHASE 5: Testing & Polish
  # ============================================================================

  - task_id: TASK-016
    spec_id: SPEC-worknote-1
    title: "Write comprehensive test suite"
    description: |
      Implement tests for all core functionality.
      - Set up Vitest with @cloudflare/vitest-pool-workers
      - Write unit tests for repositories
      - Write integration tests for API endpoints
      - Test edge cases (rate limits, errors, cascades)
      - Achieve 80% coverage target
    priority: 5
    status: pending
    estimated_effort: 12h
    acceptance_criteria:
      - "All acceptance tests from specs pass"
      - "80% code coverage achieved"
      - "Edge cases covered"

  - task_id: TASK-017
    spec_id: SPEC-worknote-1
    title: "Create basic frontend UI"
    description: |
      Build minimal frontend for testing and demonstration.
      - Dashboard with todo views (today, week, month, backlog)
      - Work note list and detail pages
      - Person and department management pages
      - Search interface (hybrid search)
      - RAG chat interfaces (global, person, dept, work)
      - PDF upload interface with polling UI
      - Optimistic UI for todo status changes
    priority: 5
    status: pending
    estimated_effort: 20h
    acceptance_criteria:
      - "All core workflows accessible via UI"
      - "Responsive design"
      - "Korean localization"
      - "Optimistic updates work smoothly"

  # ============================================================================
  # PHASE 6: Deployment & Documentation
  # ============================================================================

  - task_id: TASK-018
    spec_id: SPEC-auth-1
    title: "Configure Cloudflare Access and deploy"
    description: |
      Set up production environment.
      - Configure Cloudflare Access with Google OAuth
      - Set up AI Gateway with rate limits
      - Create production D1 database
      - Create Vectorize index
      - Set up R2 bucket with lifecycle rules
      - Configure Queue
      - Deploy Workers
      - Test end-to-end in production
    priority: 6
    status: pending
    estimated_effort: 4h
    acceptance_criteria:
      - "Production environment fully functional"
      - "Authentication works"
      - "All services integrated"

  - task_id: TASK-019
    spec_id: SPEC-worknote-1
    title: "Write user documentation"
    description: |
      Create user guide and developer documentation.
      - User guide (Korean) with screenshots
      - API documentation (auto-generated from OpenAPI spec)
      - Developer setup guide
      - Architecture overview
      - Deployment guide
    priority: 6
    status: pending
    estimated_effort: 6h
    acceptance_criteria:
      - "User guide complete"
      - "API docs published"
      - "Setup guide tested by new user"

metadata:
  total_tasks: 19
  total_estimated_effort: 107 hours
  phases:
    - name: "Infrastructure & Core"
      tasks: [TASK-001, TASK-002, TASK-003, TASK-004]
      effort: 11h

    - name: "Entity Management"
      tasks: [TASK-005, TASK-006, TASK-007, TASK-008]
      effort: 19h

    - name: "Search & AI"
      tasks: [TASK-009, TASK-010, TASK-011, TASK-012, TASK-013]
      effort: 25h

    - name: "PDF Processing"
      tasks: [TASK-014, TASK-015]
      effort: 10h

    - name: "Testing & Polish"
      tasks: [TASK-016, TASK-017]
      effort: 32h

    - name: "Deployment & Docs"
      tasks: [TASK-018, TASK-019]
      effort: 10h
