openapi: 3.0.3
info:
  title: Worknote Management API
  version: "2.0.0"
  description: >
    개인용 업무노트 관리 시스템 API.
    Cloudflare Workers + D1 + Vectorize 기반.
    인증은 Cloudflare Access(Google OAuth) 전제.

servers:
  - url: https://api.example.com
    description: Production

tags:
  - name: Auth
    description: 인증/현재 사용자 정보
  - name: Persons
    description: 사람 관리
  - name: Departments
    description: 부서 관리
  - name: WorkNotes
    description: 업무노트 관리
  - name: Todos
    description: To-do 관리
  - name: Search
    description: 검색/하이브리드 검색
  - name: RAG
    description: RAG 기반 질의응답
  - name: AI
    description: AI 생성/추천 기능
  - name: PDF
    description: PDF 기반 업무 생성

security:
  - cfAccess: []

components:
  securitySchemes:
    cfAccess:
      type: apiKey
      in: header
      name: Cf-Access-Jwt-Assertion
      description: >
        Cloudflare Access가 주입하는 JWT.
        서버에서는 필요 시 이 값을 검증해 사용자를 식별한다.

  schemas:
    Error:
      type: object
      properties:
        code:
          type: string
          description: 에러 코드
        message:
          type: string
          description: 사용자용 에러 메시지
      required: [code, message]

    Person:
      type: object
      properties:
        personId:
          type: string
          description: 6자리 고유번호 (ex. 310170)
        name:
          type: string
        currentDept:
          type: string
          nullable: true
        currentPosition:
          type: string
          nullable: true
        currentRoleDesc:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [personId, name, createdAt, updatedAt]

    PersonDeptHistory:
      type: object
      properties:
        id:
          type: integer
        deptName:
          type: string
        position:
          type: string
          nullable: true
        roleDesc:
          type: string
          nullable: true
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
          nullable: true
        isActive:
          type: boolean
      required: [id, deptName, startDate, isActive]

    Department:
      type: object
      properties:
        deptName:
          type: string
          description: 부서명 = 부서코드
        description:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
      required: [deptName, createdAt]

    WorkNotePersonRef:
      type: object
      properties:
        personId:
          type: string
        role:
          type: string
          enum: [OWNER, RELATED]
      required: [personId, role]

    WorkNote:
      type: object
      properties:
        workId:
          type: string
        title:
          type: string
        content:
          type: string
        category:
          type: string
          description: 업무 구분값 (ex. 수업성적, KORUS)
        persons:
          type: array
          items:
            $ref: '#/components/schemas/WorkNotePersonRef'
        relatedWorkIds:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [workId, title, content, createdAt, updatedAt]

    WorkNoteVersion:
      type: object
      properties:
        id:
          type: integer
        versionNo:
          type: integer
        workId:
          type: string
        title:
          type: string
        content:
          type: string
        category:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
      required: [id, versionNo, workId, title, content, createdAt]

    TodoStatus:
      type: string
      enum: [진행중, 완료, 보류, 중단]

    TodoRepeatRule:
      type: string
      enum: [NONE, DAILY, WEEKLY, MONTHLY]

    TodoRecurrenceType:
      type: string
      enum: [DUE_DATE, COMPLETION_DATE]

    Todo:
      type: object
      properties:
        todoId:
          type: string
        workId:
          type: string
        title:
          type: string
        description:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        dueDate:
          type: string
          format: date-time
        waitUntil:
          type: string
          format: date-time
          nullable: true
        status:
          $ref: '#/components/schemas/TodoStatus'
        repeatRule:
          $ref: '#/components/schemas/TodoRepeatRule'
        recurrenceType:
          $ref: '#/components/schemas/TodoRecurrenceType'
      required: [todoId, workId, title, createdAt, dueDate, status, repeatRule, recurrenceType]

    SearchResultItem:
      type: object
      properties:
        workNote:
          $ref: '#/components/schemas/WorkNote'
        score:
          type: number
          format: float
        source:
          type: string
          enum: [LEXICAL, SEMANTIC, HYBRID]
      required: [workNote, score, source]

    RagQueryRequest:
      type: object
      properties:
        query:
          type: string
          description: 사용자의 자연어 질의
        scope:
          type: string
          enum: [GLOBAL, PERSON, DEPARTMENT, WORK]
          default: GLOBAL
        personId:
          type: string
          nullable: true
        deptName:
          type: string
          nullable: true
        workId:
          type: string
          nullable: true
        topK:
          type: integer
          default: 5
      required: [query]

    RagContextSnippet:
      type: object
      properties:
        workId:
          type: string
        title:
          type: string
        snippet:
          type: string
        score:
          type: number
      required: [workId, title, snippet, score]

    RagQueryResponse:
      type: object
      properties:
        answer:
          type: string
        contexts:
          type: array
          items:
            $ref: '#/components/schemas/RagContextSnippet'
      required: [answer]

    AIDraftTodo:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
          nullable: true
        dueDateSuggestion:
          type: string
          format: date-time
          nullable: true
        repeatRule:
          $ref: '#/components/schemas/TodoRepeatRule'
          nullable: true

    WorkNoteDraft:
      type: object
      properties:
        title:
          type: string
        content:
          type: string
        category:
          type: string
          nullable: true
        todos:
          type: array
          items:
            $ref: '#/components/schemas/AIDraftTodo'
      required: [title, content]

    PdfJobStatus:
      type: string
      enum: [PENDING, PROCESSING, READY, ERROR]

    PdfJob:
      type: object
      properties:
        jobId:
          type: string
        status:
          $ref: '#/components/schemas/PdfJobStatus'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        errorMessage:
          type: string
          nullable: true
        draft:
          $ref: '#/components/schemas/WorkNoteDraft'
          nullable: true
      required: [jobId, status, createdAt, updatedAt]

paths:
  /me:
    get:
      tags: [Auth]
      summary: 현재 사용자 정보 조회
      description: Cloudflare Access 기반 단일 사용자 정보 반환.
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  email:
                    type: string
                  name:
                    type: string
                    nullable: true
        '401':
          description: 인증 실패

  /persons:
    get:
      tags: [Persons]
      summary: 사람 목록 조회
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: 이름/ID 검색어(부분 일치)
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Person'
    post:
      tags: [Persons]
      summary: 사람 생성
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/Person'
              required: [personId, name]
      responses:
        '201':
          description: 생성됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '400':
          description: 잘못된 입력
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /persons/{personId}:
    get:
      tags: [Persons]
      summary: 사람 상세 조회
      parameters:
        - name: personId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '404':
          description: 없음
    put:
      tags: [Persons]
      summary: 사람 정보 수정
      parameters:
        - name: personId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Person'
      responses:
        '200':
          description: 수정됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '404':
          description: 없음

  /persons/{personId}/history:
    get:
      tags: [Persons]
      summary: 사람 부서 배치 이력 조회
      parameters:
        - name: personId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PersonDeptHistory'

  /persons/{personId}/work-notes:
    get:
      tags: [Persons]
      summary: 특정 사람 관련 업무노트 목록
      parameters:
        - name: personId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkNote'

  /departments:
    get:
      tags: [Departments]
      summary: 부서 목록 조회
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Department'
    post:
      tags: [Departments]
      summary: 부서 생성
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/Department'
              required: [deptName]
      responses:
        '201':
          description: 생성됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'

  /departments/{deptName}:
    get:
      tags: [Departments]
      summary: 부서 상세 조회
      parameters:
        - name: deptName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'
        '404':
          description: 없음
    put:
      tags: [Departments]
      summary: 부서 정보 수정
      parameters:
        - name: deptName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Department'
      responses:
        '200':
          description: 수정됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'

  /departments/{deptName}/work-notes:
    get:
      tags: [Departments]
      summary: 특정 부서 관련 업무노트 목록
      parameters:
        - name: deptName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkNote'

  /work-notes:
    get:
      tags: [WorkNotes]
      summary: 업무노트 목록 조회
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: 키워드 검색 (간단 버전)
        - name: category
          in: query
          schema:
            type: string
        - name: personId
          in: query
          schema:
            type: string
        - name: deptName
          in: query
          schema:
            type: string
        - name: from
          in: query
          schema:
            type: string
            format: date
        - name: to
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkNote'
    post:
      tags: [WorkNotes]
      summary: 업무노트 생성
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/WorkNote'
              required: [title, content]
      responses:
        '201':
          description: 생성됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkNote'

  /work-notes/{workId}:
    get:
      tags: [WorkNotes]
      summary: 업무노트 상세 조회
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkNote'
        '404':
          description: 없음
    put:
      tags: [WorkNotes]
      summary: 업무노트 수정
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkNote'
      responses:
        '200':
          description: 수정됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkNote'
    delete:
      tags: [WorkNotes]
      summary: 업무노트 삭제
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 삭제됨

  /work-notes/{workId}/todos:
    get:
      tags: [Todos]
      summary: 특정 업무의 To-do 목록
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Todo'
    post:
      tags: [Todos]
      summary: 특정 업무에 To-do 생성
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/Todo'
              required: [title, dueDate]
      responses:
        '201':
          description: 생성됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Todo'

  /todos:
    get:
      tags: [Todos]
      summary: To-do 목록 조회(대시보드용)
      parameters:
        - name: view
          in: query
          schema:
            type: string
            enum: [today, this_week, this_month, backlog, all]
            default: today
          description: >
            today/this_week/this_month는 대기일 이전 항목 숨김,
            backlog는 기한 초과 미완료, all은 전체.
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Todo'

  /todos/{todoId}:
    patch:
      tags: [Todos]
      summary: To-do 일부 수정 (상태 등)
      parameters:
        - name: todoId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  $ref: '#/components/schemas/TodoStatus'
                title:
                  type: string
                description:
                  type: string
                dueDate:
                  type: string
                  format: date-time
                waitUntil:
                  type: string
                  format: date-time
                repeatRule:
                  $ref: '#/components/schemas/TodoRepeatRule'
                recurrenceType:
                  $ref: '#/components/schemas/TodoRecurrenceType'
      responses:
        '200':
          description: 수정됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Todo'

  /search/work-notes:
    post:
      tags: [Search]
      summary: 하이브리드 검색 기반 업무노트 검색
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                personId:
                  type: string
                  nullable: true
                deptName:
                  type: string
                  nullable: true
                category:
                  type: string
                  nullable: true
                from:
                  type: string
                  format: date
                  nullable: true
                to:
                  type: string
                  format: date
                  nullable: true
                limit:
                  type: integer
                  default: 10
              required: [query]
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SearchResultItem'

  /rag/query:
    post:
      tags: [RAG]
      summary: RAG 기반 질의응답
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RagQueryRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RagQueryResponse'

  /ai/work-notes/draft-from-text:
    post:
      tags: [AI]
      summary: 자유 텍스트 기반 업무노트 초안 생성
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                inputText:
                  type: string
                category:
                  type: string
                  nullable: true
                personIds:
                  type: array
                  items:
                    type: string
                  nullable: true
                deptName:
                  type: string
                  nullable: true
              required: [inputText]
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkNoteDraft'
        '429':
          description: AI 호출 상한 초과

  /ai/work-notes/{workId}/todo-suggestions:
    post:
      tags: [AI]
      summary: 특정 업무에 대한 To-do 추천
      parameters:
        - name: workId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                contextText:
                  type: string
                  description: 추가 컨텍스트(선택)
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AIDraftTodo'
        '429':
          description: AI 호출 상한 초과

  /pdf-jobs:
    post:
      tags: [PDF]
      summary: PDF 업로드 및 업무노트 초안 생성 작업 생성
      description: >
        PDF 파일을 업로드하고 비동기 처리 Job을 생성한다.
        응답으로 jobId를 반환하며, 클라이언트는 /pdf-jobs/{jobId}로 상태를 조회한다.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                category:
                  type: string
                  nullable: true
                personIds:
                  type: string
                  description: 콤마로 구분된 personId 목록 (선택)
                  nullable: true
                deptName:
                  type: string
                  nullable: true
      responses:
        '202':
          description: 비동기 작업 생성됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PdfJob'

  /pdf-jobs/{jobId}:
    get:
      tags: [PDF]
      summary: PDF 처리 Job 상태 조회
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PdfJob'
        '404':
          description: 없음
